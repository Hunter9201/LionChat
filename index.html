<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lion Hunter — Ask From Your Docs (Ultra‑Simple, No‑API)</title>
  <meta name="description" content="Upload a document, ask a question, get an answer grounded only in what you uploaded. 100% in‑browser. No settings. No API." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#0ea5e9;--ink:#0f172a;--muted:#64748b;--bg:#f8fafc;--line:#e2e8f0;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--brand),#0369a1);display:grid;place-items:center;color:#fff;font-weight:800}
    .title{font-weight:800}
    main{max-width:980px;margin:16px auto;padding:0 16px;display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 6px rgba(2,8,23,.04)}
    .card .body{padding:14px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.brand{background:var(--brand);color:#fff;border-color:transparent}
    .btn.small{padding:6px 10px;font-size:12px}
    .stats{font-size:12px;color:var(--muted)}
    .drop{border:2px dashed var(--line);border-radius:14px;padding:18px;text-align:center;background:#fff}
    .drop.drag{border-color:#7dd3fc;background:#f0f9ff}
    input[type="file"]{display:none}
    textarea{width:100%;min-height:64px;padding:12px;border:1px solid var(--line);border-radius:12px;font:inherit}
    .answer{border:1px solid var(--line);border-radius:12px;padding:12px;min-height:64px}
    .cite{background:#f8fafc;border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-top:10px}
    .cite .hit{padding:8px;border:1px dashed var(--line);border-radius:8px;margin:8px 0}
    .good{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lion Hunter — Ask From Your Docs</div>
        <div class="muted">Upload → Ask → Auto‑answer. Purely from your materials. No API.</div>
      </div>
    </div>
  </header>

  <main>
    <!-- Upload & tiny stats -->
    <section class="card">
      <div class="body">
        <div id="drop" class="drop" tabindex="0">
          <div style="font-weight:600;margin-bottom:6px">Drop files here or <label for="fileInput" class="btn brand" style="cursor:pointer">Browse</label></div>
          <div class="muted">PDF, DOCX, TXT, MD. (Scanned PDFs need OCR.)</div>
          <input id="fileInput" type="file" multiple accept=".pdf,.docx,.txt,.md" />
        </div>
        <div class="row" style="justify-content:space-between;margin-top:10px">
          <div class="stats" id="stats">0 documents • 0 chunks</div>
          <div class="stats" id="toast">Ready.</div>
          <button class="btn small" id="btnClear">Clear All</button>
        </div>
        <div style="margin-top:10px;height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden"><div id="bar" style="height:8px;background:var(--brand);width:0%"></div></div>
      </div>
    </section>

    <!-- Ask & Auto‑answer -->
    <section class="card">
      <div class="body">
        <textarea id="q" placeholder="Type your question... (auto‑answers)"></textarea>
        <div class="row" style="margin-top:8px;justify-content:space-between">
          <div class="muted">Tip: Press <b>Enter</b> to answer immediately. (Shift+Enter = new line)</div>
          <button class="btn brand" id="askNow">Answer now</button>
        </div>
        <div id="a" class="answer" style="margin-top:10px">Upload and ask to see answers here.</div>
        <div id="cites" class="cite"></div>
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // ---------- Storage ----------
    const kv = {
      docs: localforage.createInstance({ name: 'lh_simple_docs' }),
      chunks: localforage.createInstance({ name: 'lh_simple_chunks' })
    };

    // ---------- UI Refs ----------
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const stats = document.getElementById('stats');
    const toast = document.getElementById('toast');
    const bar = document.getElementById('bar');
    const qEl = document.getElementById('q');
    const askNow = document.getElementById('askNow');
    const aEl = document.getElementById('a');
    const citesEl = document.getElementById('cites');

    // ---------- Utils ----------
    const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);
    const ext = (name)=> (name.split('.').pop()||'').toLowerCase();
    const fmtBytes = (n)=> n>1e6? (n/1e6).toFixed(1)+' MB' : n>1e3? (n/1e3).toFixed(1)+' KB' : n+' B';
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const debounce = (fn,ms)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; };
    function escapeHtml(s){return (s||'').replace(/[&<>"']/g, c=> ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

    function setBar(p){ bar.style.width=Math.round(Math.max(0,Math.min(1,p))*100)+'%'; }
    function say(s){ toast.textContent=s; }
    function showStats(docCount, chunkCount){ stats.textContent=`${docCount} document${docCount===1?'':'s'} • ${chunkCount} chunk${chunkCount===1?'':'s'}`; }

    // ---------- Init ----------
    (async function init(){ await refreshStats(); })();

    // ---------- Drag & Drop ----------
    ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', async (e)=>{ const files=[...e.dataTransfer.files]; await addAndIndex(files); autoAnswer(); });
    drop.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async ()=>{ const files=[...fileInput.files]; await addAndIndex(files); fileInput.value=''; autoAnswer(); });

    // ---------- Clear ----------
    document.getElementById('btnClear').addEventListener('click', async ()=>{
      if(!confirm('Delete all documents and index from this browser?')) return;
      await kv.docs.clear(); await kv.chunks.clear();
      showStats(0,0); say('Cleared.'); aEl.textContent='Upload and ask to see answers here.'; citesEl.innerHTML=''; setBar(0);
    });

    // ---------- Ask (auto) ----------
    const autoAnswer = debounce(answer, 600);
    qEl.addEventListener('input', autoAnswer);
    qEl.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); answer(); }
    });
    askNow.addEventListener('click', answer);

    // ---------- Core: Add + Index ----------
    async function addAndIndex(files){
      if(!files || !files.length){ say('Choose files first'); return; }
      say('Adding…');
      let docsAdded=0, chunksAdded=0;
      for(const f of files){
        const id = uid();
        const meta = { id, name: f.name, size: f.size, ext: ext(f.name), addedAt: Date.now() };
        const buf = await f.arrayBuffer();
        await kv.docs.setItem(id+':meta', meta);
        await kv.docs.setItem(id+':bin', buf);
        docsAdded++;
        // index immediately
        const text = await extractText(meta, buf);
        if(!text || text.trim().length<20){ say(`No extractable text in ${f.name}. (Is it scanned?)`); continue; }
        const pieces = chunkText(text, 800, 200);
        let i=0; for(const p of pieces){
          const ch = { id: uid(), docId: id, name: meta.name, page: p.page||undefined, text: p.text };
          await kv.chunks.setItem(ch.id, ch); i++; chunksAdded++;
          if(i%10===0) setBar(i/pieces.length);
        }
        setBar(1);
      }
      say(`Added ${docsAdded} doc(s), indexed ${chunksAdded} chunk(s).`);
      await refreshStats();
    }

    // ---------- Extract Text ----------
    async function extractText(meta, buf){
      const e = (meta.ext||'').toLowerCase();
      if(e==='pdf') return extractPdf(buf);
      if(e==='docx') return extractDocx(buf);
      // txt / md / others → plain
      try{ return new TextDecoder().decode(buf); }catch{ return ''; }
    }
    async function extractPdf(buf){
      const loadingTask = pdfjsLib.getDocument({data:buf});
      const pdf = await loadingTask.promise; let out='';
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const text = content.items.map(it=>it.str).join(' ');
        out += `\n\n[[PAGE ${p}]]\n` + text;
      }
      return out;
    }
    async function extractDocx(buf){
      try{
        const res = await window.mammoth.extractRawText({arrayBuffer:buf});
        return res.value || '';
      }catch{ return ''; }
    }

    // ---------- Chunking ----------
    function chunkText(text, size=800, overlap=200){
      const parts=[]; const blocks = text.split(/\[\[PAGE (\d+)\]\]/g);
      if(blocks.length>1){
        for(let i=1;i<blocks.length;i+=2){
          const pageNum = parseInt(blocks[i],10);
          const pageText = (blocks[i+1]||'').trim();
          split(pageText,size,overlap).forEach(t=> parts.push({text:t,page:pageNum}));
        }
      } else {
        split(text,size,overlap).forEach(t=> parts.push({text:t}));
      }
      return parts;
    }
    function split(t,size,overlap){
      const clean=(t||'').replace(/\s+/g,' ').trim(); const out=[]; let i=0; const step=Math.max(1,size-overlap);
      while(i<clean.length){ out.push(clean.slice(i,i+size)); i+=step; }
      return out;
    }

    // ---------- Keyword Scoring (simple, fast, offline) ----------
    function keywordScore(text, query){
      const tok = s => (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
      const qT = tok(query); if(qT.length===0) return 0;
      const tT = tok(text);
      const freq = new Map(); for(const w of tT){ freq.set(w,(freq.get(w)||0)+1); }
      let score=0; for(const w of qT){ score += (freq.get(w)||0); }
      return score / Math.sqrt(tT.length+1);
    }

    // ---------- Answering ----------
    async function answer(){
      const q = qEl.value.trim();
      if(!q){ aEl.textContent='Type a question…'; citesEl.innerHTML=''; return; }
      aEl.textContent='Thinking…'; citesEl.innerHTML='';
      const pool=[]; await kv.chunks.iterate(v=> pool.push(v));
      if(!pool.length){ aEl.textContent='Your library is empty. Upload a document first.'; return; }
      for(const c of pool){ c.score = keywordScore(c.text,q); }
      pool.sort((a,b)=> b.score-a.score);
      const hits = pool.slice(0,6).filter(h=> h.score>0);
      if(!hits.length){ aEl.textContent='No relevant passages found in your uploads.'; return; }
      renderCitations(hits);
      aEl.innerHTML = escapeHtml(summarize(q,hits)).replace(/\n/g,'<br>');
    }

    function summarize(q,hits){
      const header = `Answer (from your uploads) — ${hits.length} citation(s):\n`;
      const bullets = hits.map((h,i)=>`(${i+1}) ${h.name}${h.page?` p.${h.page}`:''}:\n${truncate(h.text,480)}`).join('\n\n');
      return header + bullets;
    }

    function renderCitations(hits){
      citesEl.innerHTML = hits.map(h=> `
        <div class="hit">
          <div class="muted">${escapeHtml(h.name)}${h.page?` • p.${h.page}`:''} • score ${h.score.toFixed(3)}</div>
          <div>${escapeHtml(truncate(h.text,360))}</div>
        </div>`).join('');
    }

    function truncate(s,n){ if(!s) return ''; return s.length>n? s.slice(0,n-1)+'…' : s; }

    async function refreshStats(){
      let d=0,c=0; await kv.docs.iterate((v,k)=>{ if(k.endsWith(':meta')) d++; }); await kv.chunks.iterate(()=>{ c++; });
      showStats(d,c);
    }
  </script>
</body>
</html>
